<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="https://unpkg.com" />
    <style>
        #map { height: 500px; width: 100%; border-radius: 15px; }
        .status-badge { font-size: 0.8rem; padding: 2px 5px; }
    </style>
     <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
</head>
<body>
      <header>
        <div class="container">
            <div class="logo">
                <img class="logoImg" src="img/icone.PNG" alt="logotipo.png">
                <a href="index.html"><h1>SmartLight</h1></a>
            </div>
            <div class="nav">
                <nav>
                    <a href="login.html">Entrar</a>
                    <a href="register.html">Registrar</a>
                </nav>
            </div>
        </div>
    </header>

    <!-- Container Principal -->
    <div class="container-fluid mt-5">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse" id="sidebarMenu">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" href="index.html">
                                <i class="fas fa-tachometer-alt me-2"></i>Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="carregarPostes()">
                                <i class="fas fa-map-marker-alt me-2"></i>Postes
                                <span class="badge bg-danger float-end" id="postesComFalhaBadge">0</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="carregarAlertas()">
                                <i class="fas fa-exclamation-triangle me-2"></i>Alertas
                                <span class="badge bg-warning float-end" id="alertasPendentesBadge">0</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="carregarManutencoes()">
                                <i class="fas fa-tools me-2"></i>Manutenções
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="carregarMapa()">
                                <i class="fas fa-map me-2"></i>Mapa
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="carregarRelatorios()">
                                <i class="fas fa-chart-bar me-2"></i>Relatórios
                            </a>
                        </li>
                        <li class="nav-item">
                            <hr class="my-2">
                        </li>
                        <li class="nav-item" id="adminMenuItem" style="display: none;">
                            <h6 class="sidebar-heading px-3 mt-3 mb-1 text-muted">
                                <span>Administração</span>
                            </h6>
                            <a class="nav-link" href="admin.html">
                                <i class="fas fa-users-cog me-2"></i>Painel Admin
                            </a>
                        </li>
                        <li class="nav-item" id="tecnicoMenuItem" style="display: none;">
                            <h6 class="sidebar-heading px-3 mt-3 mb-1 text-muted">
                                <span>Operações</span>
                            </h6>
                            <a class="nav-link" href="tecnico.html">
                                <i class="fas fa-toolbox me-2"></i>Painel Técnico
                            </a>
                        </li>
                    </ul>
                    
                    <div class="mt-4 px-3">
                        <div class="card bg-light border-0">
                            <div class="card-body p-3">
                                <h6 class="card-title">Status do Sistema</h6>
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <small>Postes Online:</small>
                                    <span class="badge bg-success" id="postesOnline">0</span>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <small>Central Online:</small>
                                    <span class="badge bg-success" id="centralOnline">Sim</span>
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <small>Última Atualização:</small>
                                    <small id="ultimaAtualizacao">Agora</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Conteúdo Principal -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <!-- Breadcrumb -->
                <nav aria-label="breadcrumb" class="mt-3">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item active" aria-current="page">Dashboard</li>
                    </ol>
                </nav>

                <!-- Conteúdo Dinâmico -->
                <div id="conteudoPrincipal">
                    <!-- Cards de Resumo -->
                    <div class="row mb-4">
                        <div class="col-xl-3 col-md-6 mb-4">
                            <div class="card border-left-primary shadow h-100 py-2">
                                <div class="card-body">
                                    <div class="row no-gutters align-items-center">
                                        <div class="col mr-2">
                                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                                Total de Postes</div>
                                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalPostes">0</div>
                                        </div>
                                        <div class="col-auto">
                                            <i class="fas fa-lightbulb fa-2x text-gray-300"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-xl-3 col-md-6 mb-4">
                            <div class="card border-left-warning shadow h-100 py-2">
                                <div class="card-body">
                                    <div class="row no-gutters align-items-center">
                                        <div class="col mr-2">
                                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                                Com Falha</div>
                                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="postesComFalha">0</div>
                                        </div>
                                        <div class="col-auto">
                                            <i class="fas fa-exclamation-triangle fa-2x text-gray-300"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-xl-3 col-md-6 mb-4">
                            <div class="card border-left-success shadow h-100 py-2">
                                <div class="card-body">
                                    <div class="row no-gutters align-items-center">
                                        <div class="col mr-2">
                                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                                Consumo Atual</div>
                                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="consumoAtual">0 kW</div>
                                        </div>
                                        <div class="col-auto">
                                            <i class="fas fa-bolt fa-2x text-gray-300"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-xl-3 col-md-6 mb-4">
                            <div class="card border-left-info shadow h-100 py-2">
                                <div class="card-body">
                                    <div class="row no-gutters align-items-center">
                                        <div class="col mr-2">
                                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                                Alertas Hoje</div>
                                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="alertasHoje">0</div>
                                        </div>
                                        <div class="col-auto">
                                            <i class="fas fa-bell fa-2x text-gray-300"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Gráficos e Mapas -->
                    <div class="row">
                        <!-- Mapa de Calor -->
                        <div class="col-xl-8 col-lg-7">
                            <div class="card shadow mb-4">
                                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                                    <h6 class="m-0 font-weight-bold text-primary">Mapa de Postes</h6>
                                    <div class="dropdown no-arrow">
                                        <a class="dropdown-toggle" href="#" role="button" id="dropdownMenuLink"
                                            data-bs-toggle="dropdown">
                                            <i class="fas fa-ellipsis-v fa-sm fa-fw text-gray-400"></i>
                                        </a>
                                        <ul class="dropdown-menu dropdown-menu-end shadow">
                                            <li><a class="dropdown-item" href="#" onclick="carregarMapa()">Ver Mapa Completo</a></li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li><a class="dropdown-item" href="#" onclick="atualizarMapa()">Atualizar</a></li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div id="mapaDashboard" style="height: 400px; border-radius: 5px;">
                                        <div class="text-center py-5">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Carregando mapa...</span>
                                            </div>
                                            <p class="mt-3">Carregando mapa de postes...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Gráfico de Estados -->
                        <div class="col-xl-4 col-lg-5">
                            <div class="card shadow mb-4">
                                <div class="card-header py-3">
                                    <h6 class="m-0 font-weight-bold text-primary">Distribuição por Estado</h6>
                                </div>
                                <div class="card-body">
                                    <div class="chart-pie pt-4">
                                        <canvas id="estadoPostesChart" height="200"></canvas>
                                    </div>
                                    <div class="mt-4 text-center small">
                                        <span class="mr-2">
                                            <i class="fas fa-circle text-success"></i> OK
                                        </span>
                                        <span class="mr-2">
                                            <i class="fas fa-circle text-danger"></i> Com Falha
                                        </span>
                                        <span class="mr-2">
                                            <i class="fas fa-circle text-secondary"></i> Desligado
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tabelas de Dados -->
                    <div class="row">
                        <!-- Postes Recentemente Atualizados -->
                        <div class="col-xl-6 col-lg-12">
                            <div class="card shadow mb-4">
                                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                                    <h6 class="m-0 font-weight-bold text-primary">Postes Recentes</h6>
                                    <a href="#" class="btn btn-sm btn-primary" onclick="carregarPostes()">Ver Todos</a>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover" id="tabelaPostesRecentes">
                                            <thead>
                                                <tr>
                                                    <th>ID</th>
                                                    <th>Localização</th>
                                                    <th>Estado</th>
                                                    <th>Última Leitura</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td colspan="4" class="text-center">
                                                        <div class="spinner-border spinner-border-sm" role="status">
                                                            <span class="visually-hidden">Carregando...</span>
                                                        </div>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Alertas Recentes -->
                        <div class="col-xl-6 col-lg-12">
                            <div class="card shadow mb-4">
                                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                                    <h6 class="m-0 font-weight-bold text-primary">Alertas Recentes</h6>
                                    <a href="#" class="btn btn-sm btn-primary" onclick="carregarAlertas()">Ver Todos</a>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover" id="tabelaAlertasRecentes">
                                            <thead>
                                                <tr>
                                                    <th>Código</th>
                                                    <th>Tipo</th>
                                                    <th>Local</th>
                                                    <th>Status</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td colspan="4" class="text-center">
                                                        <div class="spinner-border spinner-border-sm" role="status">
                                                            <span class="visually-hidden">Carregando...</span>
                                                        </div>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Informações do Sistema -->
                    <div class="row">
                        <div class="col-lg-12">
                            <div class="card shadow mb-4">
                                <div class="card-header py-3">
                                    <h6 class="m-0 font-weight-bold text-primary">Status do Sistema</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-3 col-6 mb-3">
                                            <div class="text-center">
                                                <div class="h4" id="uptimeSistema">99.9%</div>
                                                <small class="text-muted">Uptime do Sistema</small>
                                            </div>
                                        </div>
                                        <div class="col-md-3 col-6 mb-3">
                                            <div class="text-center">
                                                <div class="h4" id="postesAtivos">0</div>
                                                <small class="text-muted">Postes Ativos</small>
                                            </div>
                                        </div>
                                        <div class="col-md-3 col-6 mb-3">
                                            <div class="text-center">
                                                <div class="h4" id="manutencoesHoje">0</div>
                                                <small class="text-muted">Manutenções Hoje</small>
                                            </div>
                                        </div>
                                        <div class="col-md-3 col-6 mb-3">
                                            <div class="text-center">
                                                <div class="h4" id="tempoResposta">0s</div>
                                                <small class="text-muted">Tempo de Resposta</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modal de Perfil -->
    <div class="modal fade" id="perfilModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Meu Perfil</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formPerfil">
                        <div class="mb-3">
                            <label class="form-label">Nome Completo</label>
                            <input type="text" class="form-control" id="perfilNome" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" id="perfilEmail" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Telefone</label>
                            <input type="tel" class="form-control" id="perfilTelefone">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Tipo de Usuário</label>
                            <input type="text" class="form-control" id="perfilTipo" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Província</label>
                            <input type="text" class="form-control" id="perfilProvincia" readonly>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-primary" onclick="salvarPerfil()">Salvar Alterações</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Mudança de Senha -->
    <div class="modal fade" id="senhaModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Mudar Senha</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formSenha">
                        <div class="mb-3">
                            <label class="form-label">Senha Atual</label>
                            <input type="password" class="form-control" id="senhaAtual" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Nova Senha</label>
                            <input type="password" class="form-control" id="novaSenha" minlength="6" required>
                            <div class="form-text">Mínimo 6 caracteres</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Confirmar Nova Senha</label>
                            <input type="password" class="form-control" id="confirmarSenha" required>
                            <div class="invalid-feedback" id="senhaError">As senhas não coincidem</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="confirmarMudancaSenha()">Mudar Senha</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <script>
        // Variáveis globais
        let mapa = null;
        let marcadores = [];
        let usuario = null;
        let chartEstado = null;
        
        // Inicialização quando a página carrega
        document.addEventListener('DOMContentLoaded', function() {
            //verificarAutenticacao();
            carregarDashboard();
            iniciarAtualizacaoAutomatica();
            carregarMapaDashboard();
        });
        
        // Verificar se usuário está autenticado
        /*function verificarAutenticacao() {
            usuario = JSON.parse(localStorage.getItem('user'));
            const token = localStorage.getItem('token');
            
            if (!usuario || !token) {
                window.location.href = 'login.html';
                return;
            }
            
            // Atualizar informações do usuário na navbar
            document.getElementById('userNameNav').textContent = usuario.nome || usuario.username;
            document.getElementById('userEmailNav').textContent = usuario.email || usuario.username;
            
            // Mostrar menus baseados no tipo de usuário
            if (usuario.tipo === 'admin' || usuario.tipo === 'supervisor') {
                document.getElementById('adminMenuItem').style.display = 'block';
            }
            
            if (usuario.tipo === 'tecnico') {
                document.getElementById('tecnicoMenuItem').style.display = 'block';
            }
            
            // Carregar notificações
            carregarNotificacoes();
        }*/
        
        // Carregar dados do dashboard
        async function carregarDashboard() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/postes/dashboard/resumo', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) throw new Error('Erro ao carregar dashboard');
                
                const data = await response.json();
                atualizarDashboard(data);
                
            } catch (error) {
                console.error('Erro:', error);
                mostrarAlerta('Erro ao carregar dashboard. Tente recarregar a página.', 'danger');
            }
        }
        
        // Atualizar dashboard com dados
        function atualizarDashboard(data) {
            // Atualizar cards
            document.getElementById('totalPostes').textContent = data.totais?.postes || 0;
            document.getElementById('postesComFalha').textContent = data.totais?.com_falha || 0;
            document.getElementById('consumoAtual').textContent = (data.totais?.potencia || 0).toFixed(2) + ' kW';
            
            // Atualizar badges
            document.getElementById('postesComFalhaBadge').textContent = data.totais?.com_falha || 0;
            
            // Atualizar tabela de postes recentes
            atualizarTabelaPostesRecentes(data.postes_problematicos || []);
            
            // Atualizar gráfico de estados
            atualizarGraficoEstados(data.distribuicao_estado || []);
            
            // Atualizar horário
            document.getElementById('ultimaAtualizacao').textContent = 
                new Date().toLocaleTimeString('pt-AO', { hour: '2-digit', minute: '2-digit' });
        }
        
        // Atualizar tabela de postes recentes
        function atualizarTabelaPostesRecentes(postes) {
            const tbody = document.querySelector('#tabelaPostesRecentes tbody');
            
            if (postes.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center text-muted">
                            Nenhum poste com atividade recente
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = postes.slice(0, 5).map(poste => `
                <tr>
                    <td><a href="#" onclick="verPoste('${poste.poste_id}')" class="text-decoration-none">${poste.poste_id}</a></td>
                    <td>${poste.zona || 'N/A'}</td>
                    <td>
                        <span class="badge bg-danger">
                            ${poste.falhas} falha${poste.falhas > 1 ? 's' : ''}
                        </span>
                    </td>
                    <td>${formatarDataRelativa(poste.ultima_falha)}</td>
                </tr>
            `).join('');
        }
        
        // Atualizar gráfico de estados
        function atualizarGraficoEstados(dados) {
            const ctx = document.getElementById('estadoPostesChart').getContext('2d');
            
            // Destruir gráfico anterior se existir
            if (chartEstado) {
                chartEstado.destroy();
            }
            
            const labels = dados.map(d => d.estado);
            const valores = dados.map(d => d.quantidade);
            
            const cores = labels.map(label => {
                switch(label) {
                    case 'OK': return '#28a745';
                    case 'Queimada': return '#dc3545';
                    case 'Fio Cortado': return '#6c757d';
                    case 'Sem Consumo': return '#ffc107';
                    case 'Vandalismo': return '#fd7e14';
                    case 'Desligada': return '#17a2b8';
                    default: return '#6f42c1';
                }
            });
            
            chartEstado = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: valores,
                        backgroundColor: cores,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
        
        // Carregar mapa no dashboard
        function carregarMapaDashboard() {
            const container = document.getElementById('mapaDashboard');
            
            // Inicializar mapa
            mapa = L.map('mapaDashboard').setView([-8.8383, 13.2344], 12);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(mapa);
            
            // Adicionar marcadores de exemplo (em produção viria da API)
            adicionarMarcadoresExemplo();
        }
        
        function adicionarMarcadoresExemplo() {
            const postesExemplo = [
                { id: '1301045112', lat: -8.998458, lng: 13.257396, estado: 'ok', zona: '045' },
                { id: '10010123007', lat: -12.7761, lng: 15.7392, estado: 'falha', zona: '123' },
                { id: '17010301654', lat: -11.78842, lng: 19.91534, estado: 'ok', zona: '301' }
            ];
            
            postesExemplo.forEach(poste => {
                let corIcone;
                let iconeTexto;
                
                switch(poste.estado) {
                    case 'ok':
                        corIcone = 'green';
                        iconeTexto = '✔';
                        break;
                    case 'falha':
                        corIcone = 'red';
                        iconeTexto = '⚠';
                        break;
                    default:
                        corIcone = 'gray';
                        iconeTexto = '?';
                }
                
                const icone = L.divIcon({
                    html: `
                        <div style="
                            background-color: ${corIcone};
                            color: white;
                            width: 30px;
                            height: 30px;
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-weight: bold;
                            border: 2px solid white;
                            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
                        ">
                            ${iconeTexto}
                        </div>
                    `,
                    className: 'custom-div-icon',
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                });
                
                const marcador = L.marker([poste.lat, poste.lng], { icon: icone })
                    .bindPopup(`
                        <b>Poste ${poste.id}</b><br>
                        Zona: ${poste.zona}<br>
                        Estado: ${poste.estado === 'ok' ? 'OK' : 'Com Falha'}<br>
                        <a href="#" onclick="verPoste('${poste.id}')">Ver detalhes</a>
                    `)
                    .addTo(mapa);
                
                marcadores.push(marcador);
            });
            
            // Ajustar zoom para mostrar todos os marcadores
            if (marcadores.length > 0) {
                const grupo = L.featureGroup(marcadores);
                mapa.fitBounds(grupo.getBounds().pad(0.1));
            }
        }
        
        // Carregar notificações
        async function carregarNotificacoes() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/alertas?status=pendente&limit=5', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    atualizarNotificacoes(data.alertas || []);
                }
            } catch (error) {
                console.error('Erro ao carregar notificações:', error);
            }
        }
        
        function atualizarNotificacoes(alertas) {
            const badge = document.getElementById('notificacaoBadge');
            const lista = document.getElementById('notificacoesLista');
            
            badge.textContent = alertas.length;
            badge.style.display = alertas.length > 0 ? 'inline' : 'none';
            
            // Limpar lista exceto os headers
            const items = lista.querySelectorAll('.dropdown-item:not(.dropdown-header)');
            items.forEach(item => item.remove());
            
            if (alertas.length === 0) {
                const item = document.createElement('li');
                item.innerHTML = '<a class="dropdown-item" href="#" id="semNotificacoes">Nenhuma notificação</a>';
                lista.insertBefore(item, lista.querySelector('.dropdown-divider').nextSibling);
                return;
            }
            
            alertas.forEach(alerta => {
                const item = document.createElement('li');
                item.innerHTML = `
                    <a class="dropdown-item" href="#" onclick="verAlerta(${alerta.id})">
                        <div class="d-flex">
                            <div class="flex-shrink-0">
                                <i class="fas fa-exclamation-triangle text-warning"></i>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <div class="small text-gray-500">${formatarDataRelativa(alerta.data_criacao)}</div>
                                ${alerta.tipo} - ${alerta.descricao.substring(0, 50)}...
                            </div>
                        </div>
                    </a>
                `;
                lista.insertBefore(item, lista.querySelector('.dropdown-divider').nextSibling);
            });
        }
        
        // Navegação
        function carregarPostes() {
            window.location.href = 'postes.html';
        }
        
        function carregarAlertas() {
            window.location.href = 'alertas.html';
        }
        
        function carregarManutencoes() {
            window.location.href = 'manutencoes.html';
        }
        
        function carregarMapa() {
            window.location.href = 'mapa.html';
        }
        
        function carregarRelatorios() {
            window.location.href = 'relatorios.html';
        }
        
        function verPoste(id) {
            window.location.href = `poste.html?id=${id}`;
        }
        
        function verAlerta(id) {
            window.location.href = `alerta.html?id=${id}`;
        }
        
        // Perfil do usuário
        function perfilUsuario() {
            const modal = new bootstrap.Modal(document.getElementById('perfilModal'));
            
            // Preencher formulário com dados do usuário
            document.getElementById('perfilNome').value = usuario.nome || '';
            document.getElementById('perfilEmail').value = usuario.email || '';
            document.getElementById('perfilTelefone').value = usuario.telefone || '';
            document.getElementById('perfilTipo').value = usuario.tipo || '';
            document.getElementById('perfilProvincia').value = usuario.provincia_nome || 'Todas';
            
            modal.show();
        }
        
        async function salvarPerfil() {
            // Implementar salvar perfil
            mostrarAlerta('Perfil atualizado com sucesso!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('perfilModal')).hide();
        }
        
        function mudarSenha() {
            const modal = new bootstrap.Modal(document.getElementById('senhaModal'));
            modal.show();
        }
        
        async function confirmarMudancaSenha() {
            const novaSenha = document.getElementById('novaSenha').value;
            const confirmarSenha = document.getElementById('confirmarSenha').value;
            
            if (novaSenha !== confirmarSenha) {
                document.getElementById('confirmarSenha').classList.add('is-invalid');
                return;
            }
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/auth/change-password', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        currentPassword: document.getElementById('senhaAtual').value,
                        newPassword: novaSenha
                    })
                });
                
                if (response.ok) {
                    mostrarAlerta('Senha alterada com sucesso!', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('senhaModal')).hide();
                } else {
                    const error = await response.json();
                    throw new Error(error.error || 'Erro ao alterar senha');
                }
            } catch (error) {
                mostrarAlerta(error.message, 'danger');
            }
        }
        
        // Atualização automática
        function iniciarAtualizacaoAutomatica() {
            // Atualizar dashboard a cada 30 segundos
            setInterval(() => {
                carregarDashboard();
                carregarNotificacoes();
            }, 30000);
            
            // Atualizar tempo a cada minuto
            setInterval(() => {
                document.getElementById('ultimaAtualizacao').textContent = 
                    new Date().toLocaleTimeString('pt-AO', { hour: '2-digit', minute: '2-digit' });
            }, 60000);
        }
        
        // Funções utilitárias
        function formatarDataRelativa(data) {
            if (!data) return 'Nunca';
            
            const agora = new Date();
            const dataObj = new Date(data);
            const diffMs = agora - dataObj;
            const diffMin = Math.floor(diffMs / 60000);
            const diffHora = Math.floor(diffMin / 60);
            const diffDia = Math.floor(diffHora / 24);
            
            if (diffMin < 1) return 'agora mesmo';
            if (diffMin < 60) return `há ${diffMin} min`;
            if (diffHora < 24) return `há ${diffHora} h`;
            if (diffDia < 7) return `há ${diffDia} d`;
            
            return dataObj.toLocaleDateString('pt-AO');
        }
        
        function mostrarAlerta(mensagem, tipo = 'info') {
            const alerta = document.createElement('div');
            alerta.className = `alert alert-${tipo} alert-dismissible fade show position-fixed`;
            alerta.style.cssText = `
                top: 80px;
                right: 20px;
                z-index: 1050;
                min-width: 300px;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            `;
            alerta.innerHTML = `
                ${mensagem}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(alerta);
            
            setTimeout(() => {
                if (alerta.parentNode) {
                    alerta.remove();
                }
            }, 5000);
        }
        
        function sair() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = 'login.html';
        }
        
        // Inicializar tooltips
        document.addEventListener('DOMContentLoaded', function() {
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        });
    </script>


<script src="js/dashboardteste.js"></script>
  <!--Footer Section-->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3><i class="fas fa-lightbulb"></i> SmartLight</h3>
                    <p>Sistema de Monitoramento de Falhas de Iluminação Pública</p>
                </div>
                <div class="footer-section">
                    <h4>Links</h4>
                    <ul>
                        <li><a href="#">Sobre</a></li>
                        <li><a href="#">Termos</a></li>
                        <li><a href="#">Políticas</a></li>
                        <li><a href="#">Contactos</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                    <p>&copy; 2026 SmartLight. Todos os direitos revervados</p>
                </div>
        </div>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>