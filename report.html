<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reportar Falha | SmartLight</title>
    <!-- CSS e Icons -->
    <link href="https://cdn.jsdelivr.net" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com">
    <style>
        :root { --primary-color: #0d6efd; --secondary-color: #ffc107; }
        body { background-color: #f8f9fa; }
        .report-card { max-width: 700px; margin: 30px auto; background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        .btn-location { background-color: #e9ecef; border: 2px dashed #adb5bd; color: #495057; width: 100%; padding: 15px; border-radius: 10px; transition: 0.3s; }
        .btn-location:hover { background-color: #dee2e6; border-color: var(--primary-color); color: var(--primary-color); }
        .photo-upload { border: 2px dashed var(--primary-color); border-radius: 15px; padding: 40px; text-align: center; cursor: pointer; background: #f0f7ff; position: relative; }
        .img-preview { max-width: 100%; border-radius: 10px; margin-top: 15px; display: none; }
        .step-title { font-weight: 700; color: #212529; margin-bottom: 20px; border-left: 5px solid var(--secondary-color); padding-left: 15px; }
        .loader-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: none; justify-content: center; align-items: center; color: white; flex-direction: column; }
    </style>
</head>
<body>

    <div id="loader-overlay" class="loader-overlay">
        <div class="spinner-border text-warning" role="status"></div>
        <p class="mt-3" id="loader-text">A enviar o seu reporte...</p>
    </div>

    <header class="bg-white py-3 border-bottom shadow-sm">
        <div class="container d-flex justify-content-between align-items-center">
            <div class="logo d-flex align-items-center">
                <a href="index.html" class="text-decoration-none d-flex align-items-center">
                    <h1 class="h4 m-0 fw-bold text-dark">SmartLight</h1>
                </a>
            </div>
            <a href="dashboard.html" class="btn btn-outline-dark btn-sm">Voltar</a>
        </div>
    </header>

    <main class="container px-3">
        <div class="report-card">
            <h2 class="text-center mb-4">Avisar Falha de Iluminação</h2>
            
            <form id="reportForm">
                <!-- 1. Localização -->
                <div class="mb-5">
                    <h5 class="step-title">1. Onde está o poste?</h5>
                    <button type="button" id="getLocation" class="btn-location">
                        <i class="fas fa-map-marker-alt fa-2x mb-2"></i><br>
                        <span id="locationStatus">Clique para capturar a localização atual</span>
                    </button>
                    <input type="hidden" id="coords" required>
                </div>

                <!-- 2. Tipo -->
                <div class="mb-5">
                    <h5 class="step-title">2. Qual é o problema?</h5>
                    <div class="row g-2">
                        <div class="col-6">
                            <input type="radio" class="btn-check" name="tipoProblema" id="p1" value="Lâmpada Fundida" checked>
                            <label class="btn btn-outline-primary w-100 py-3" for="p1">Fundida</label>
                        </div>
                        <div class="col-6">
                            <input type="radio" class="btn-check" name="tipoProblema" id="p2" value="Poste Partido">
                            <label class="btn btn-outline-primary w-100 py-3" for="p2">Partido</label>
                        </div>
                    </div>
                </div>

                <!-- 3. Foto -->
                <div class="mb-5">
                    <h5 class="step-title">3. Foto da Ocorrência</h5>
                    <div class="photo-upload" onclick="document.getElementById('fileInput').click()">
                        <i class="fas fa-camera fa-3x mb-2 text-primary"></i>
                        <p class="m-0">Tirar foto ou escolher galeria</p>
                        <input type="file" id="fileInput" accept="image/*" class="d-none">
                        <img id="preview" class="img-preview">
                    </div>
                </div>

                <!-- 4. Descrição -->
                <div class="mb-5">
                    <h5 class="step-title">4. Detalhes Adicionais</h5>
                    <textarea class="form-control" id="descricao" rows="3" placeholder="Ex: Próximo à paragem..."></textarea>
                </div>

                <button type="submit" class="btn btn-warning btn-lg w-100 py-3 fw-bold text-dark shadow">
                    ENVIAR AVISO
                </button>
            </form>
        </div>
    </main>

    <!-- FIREBASE SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com";

        const firebaseConfig = {
            apiKey: "SUA_API_KEY",
            authDomain: "SEU_PROJETO.firebaseapp.com",
            projectId: "SEU_PROJETO",
            storageBucket: "SEU_PROJETO.appspot.com",
            appId: "SEU_ID"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // Preview da Imagem
        document.getElementById('fileInput').onchange = e => {
            const [file] = e.target.files;
            if (file) {
                document.getElementById('preview').src = URL.createObjectURL(file);
                document.getElementById('preview').style.display = 'block';
            }
        };

        // GPS
        document.getElementById('getLocation').onclick = () => {
            const status = document.getElementById('locationStatus');
            navigator.geolocation.getCurrentPosition(pos => {
                document.getElementById('coords').value = `${pos.coords.latitude},${pos.coords.longitude}`;
                status.innerHTML = "✅ Localização Capturada!";
            }, () => alert("Ative o GPS!"));
        };

        // Envio
        document.getElementById('reportForm').onsubmit = async (e) => {
            e.preventDefault();
            const loader = document.getElementById('loader-overlay');
            loader.style.display = 'flex';

            try {
                const file = document.getElementById('fileInput').files[0];
                let fotoUrl = "sem-foto";

                if (file) {
                    const storageRef = ref(storage, `reportes/${Date.now()}_${file.name}`);
                    await uploadBytes(storageRef, file);
                    fotoUrl = await getDownloadURL(storageRef);
                }

                await addDoc(collection(db, "reportes"), {
                    tipo: document.querySelector('input[name="tipoProblema"]:checked').value,
                    coordenadas: document.getElementById('coords').value,
                    descricao: document.getElementById('descricao').value,
                    foto: fotoUrl,
                    status: "pendente",
                    data: serverTimestamp()
                });

                alert("Sucesso! O administrador foi notificado.");
                window.location.href = "dashboard.html";
            } catch (err) {
                console.error(err);
                alert("Erro ao enviar.");
                loader.style.display = 'none';
            }
        };
    </script>
</body>
</html>
